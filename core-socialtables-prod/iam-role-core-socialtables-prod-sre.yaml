AWSTemplateFormatVersion: 2010-09-09
Description: Create federated IAM roles

Parameters:

    AccountName:
        Description: The name of the AWS account this template is launched in.
        Type: String

Resources:

    Sre:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument: !Sub
                |
                {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Principal": {
                        "Federated": "arn:aws:iam::${AWS::AccountId}:saml-provider/okta-sso"
                      },
                      "Action": "sts:AssumeRoleWithSAML",
                      "Condition": {
                        "StringEquals": {
                          "SAML:aud": "https://signin.aws.amazon.com/saml"
                        }
                      }
                    },
                    {
                      "Effect": "Allow",
                      "Principal": {
                        "AWS": "arn:aws:iam::667621734181:root"
                      },
                      "Action": "sts:AssumeRole",
                      "Condition": {}
                    }
                  ]
                }
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/PowerUserAccess
                - arn:aws:iam::aws:policy/IAMReadOnlyAccess
            RoleName: !Sub
                - "${Account}-sre"
                - Account: !Ref AccountName

    CoreSocialtablesProdIamPolicy:
        Type: AWS::IAM::Policy
        Properties:
            PolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Sid: Stmt1566851350326
                      Action:
                          - iam:PassRole
                      Effect: Allow
                      Resource:
                          - arn:aws:iam::128086499455:instance-profile/core-socialtables-prod-socialtables-ecs-profile
                          - arn:aws:iam::128086499455:role/core-socialtables-prod-socialtables-ecs
            PolicyName: !Sub
                - "${Account}-socialtables-iam-policy"
                - Account: !Ref AccountName
            Roles:
                - !Ref Sre
