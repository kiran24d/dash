---
AWSTemplateFormatVersion: '2010-09-09'
Description: ICR-3119, Add roles and policies for kapow image handler

Parameters:
  OriginS3Bucket:
    Description: S3 bucket that will source your images.
    Type: String
    ConstraintDescription: Must be a valid S3 Bucket.
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9-.]*'
Resources:
  ImageHandlerS3Policy:
    DependsOn:
      - ImageHandlerRole
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Join
        - ''
        - - !Ref 'AWS::StackName'
          - S3ReadPolicy
      Roles:
        - !Ref 'ImageHandlerRole'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref 'OriginS3Bucket'
                - /*
  ImageHandlerLogPolicy:
    DependsOn:
      - ImageHandlerRole
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Join
        - ''
        - - !Ref 'AWS::StackName'
          - LogPolicy
      Roles:
        - !Ref 'ImageHandlerRole'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: !Join
              - ''
              - - 'arn:aws:logs:'
                - !Ref 'AWS::Region'
                - ':'
                - !Ref 'AWS::AccountId'
                - :log-group:/aws/lambda/*
  ImageHandlerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      RoleName: !Join
        - ''
        - - !Ref 'AWS::StackName'
          - Role
